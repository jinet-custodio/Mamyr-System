 CREATE TABLE notification (
    notificationID INT AUTO_INCREMENT PRIMARY KEY,
    bookingID INT NULL,
    partnershipID INT NULL,
    senderID INT DEFAULT NULL,
    message TEXT NOT NULL,
    receiver ENUM ('Admin', 'Partner', 'Customer') NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_read BOOLEAN DEFAULT 0,

    FOREIGN KEY (bookingID) REFERENCES booking(bookingID),
    FOREIGN KEY (partnershipID) REFERENCES partnership(partnershipID),
    FOREIGN KEY (senderID) REFERENCES user(userID)
);


ALTER TABLE notification
ADD receiverID INT DEFAULT NULL AFTER senderID;

ALTER TABLE notification
ADD CONSTRAINT notification_ibfk_receiver
FOREIGN KEY (receiverID) REFERENCES user(userID)
ON DELETE RESTRICT
ON UPDATE RESTRICT;


CREATE TABLE userreview (
    userReviewID INT PRIMARY KEY AUTO_INCREMENT,
    bookingID INT,
    bookingType VARCHAR(50),
    reviewRating DECIMAL(2,1),
    reviewComment TEXT,
    FOREIGN KEY (bookingID) REFERENCES booking(bookingID)
);

ALTER TABLE `userreview`
ADD dateReviewed TIMESTAMP DEFAULT CURRENT_TIMESTAMP;


CREATE TABLE pushsubscription (
    subscriptionID INT AUTO_INCREMENT PRIMARY KEY,
    userID INT NOT NULL,
    endpoint VARCHAR(255) NOT NULL,
    p256dh VARCHAR(255) NOT NULL,
    auth VARCHAR(255) NOT NULL,
	UNIQUE KEY unique_sub(userID, endpoint),
    FOREIGN KEY (userID) REFERENCES user(userID) 
);

ALTER TABLE `pushsubscription` DROP FOREIGN KEY `pushsubscription_ibfk_1`; ALTER TABLE `pushsubscription` ADD CONSTRAINT `pushsubscription_ibfk_1` FOREIGN KEY (`userID`) REFERENCES `user`(`userID`) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE `notification` CHANGE `receiver` `receiver` ENUM('Admin','Business Partner','Customer') CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL;


ALTER TABLE `notification` CHANGE `receiver` `receiver` ENUM('Admin','Business Partner','Customer', 'Partnership Applicant') CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL;