USE mamyr;

-- Booking Table
CREATE TABLE booking (
    bookingID INT PRIMARY KEY AUTO_INCREMENT,
    userID INT NOT NULL,
    bookingType ENUM('Resort', 'Hotel', 'Event') NOT NULL,
    customPackageID INT NULL,
    additionalRequest TEXT,
    toddlerCount INT DEFAULT 0,
    kidCount INT DEFAULT 0,
    adultCount INT DEFAULT 0,
    guestCount INT NOT NULL,
    durationCount INT NOT NULL,
    arrivalTime TIME NULL,
    startDate DATETIME NOT NULL,
    endDate DATETIME NOT NULL,
    paymentMethod VARCHAR(50) NOT NULL,
    bookingOrigin ENUM('Online', 'Walk-In') NOT NULL DEFAULT 'Online',
    customerChoice ENUM('Proceed', 'Cancel') DEFAULT NULL,
    totalCost DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    downpayment DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    bookingStatus INT DEFAULT 1,
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    approvedBy VARCHAR(25) DEFAULT NULL,
    approvedDate DATETIME NULL,
    FOREIGN KEY (userID) REFERENCES user(userID),
    FOREIGN KEY (bookingStatus) REFERENCES status(statusID),
    FOREIGN KEY (customPackageID) REFERENCES custompackage(customPackageID)
);

ALTER TABLE `booking` ADD `addOns` VARCHAR(255) NOT NULL DEFAULT 'N/A' AFTER `bookingOrigin`;
ALTER TABLE `booking` ADD `bookingCode` VARCHAR(20) NOT NULL AFTER `bookingID`;

-- Booking Service Table
CREATE TABLE bookingservice (
    bookingServiceID INT PRIMARY KEY AUTO_INCREMENT,
    bookingID INT NOT NULL,
    serviceID INT NOT NULL,
    guests INT NOT NULL,
    bookingServicePrice DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (bookingID) REFERENCES booking(bookingID),
    FOREIGN KEY (serviceID) REFERENCES service(serviceID)
);

-- Confirmed Booking Table
CREATE TABLE confirmedbooking (
    confirmedBookingID INT PRIMARY KEY AUTO_INCREMENT,
    bookingID INT NOT NULL,
    downpaymentImage VARCHAR(255) DEFAULT 'defaultDownpayment.png',
    discountAmount DECIMAL(10,2) DEFAULT 0.00,
    additionalCharge DECIMAL(10,2) DEFAULT 0.00,
    finalBill DECIMAL(10,2) DEFAULT 0.00,
    amountPaid DECIMAL(10,2) DEFAULT 0.00,
    userBalance DECIMAL(10,2) DEFAULT 0.00,
    paymentApprovalStatus INT DEFAULT 1,
    paymentStatus INT NOT NULL DEFAULT 1, -- only here
    paymentDueDate DATETIME NULL,
    downpaymentDueDate DATETIME NULL,
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (bookingID) REFERENCES booking(bookingID),
    FOREIGN KEY (paymentApprovalStatus) REFERENCES status(statusID),
    FOREIGN KEY (paymentStatus) REFERENCES paymentstatus(paymentStatusID)
);

-- Business Partner Availed Service Table
CREATE TABLE businesspartneravailedservice (
    BPavailedService INT PRIMARY KEY AUTO_INCREMENT,
    partnershipServiceID INT NOT NULL,
    bookingID INT NOT NULL,
    approvalStatus INT,
    price DECIMAL(10,2) DEFAULT 0.00,
    availedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (partnershipServiceID) REFERENCES partnershipservice(partnershipServiceID),
    FOREIGN KEY (bookingID) REFERENCES booking(bookingID),
    FOREIGN KEY (approvalStatus) REFERENCES status(statusID)
);

CREATE TABLE payment (
    paymentID INT PRIMARY KEY AUTO_INCREMENT,
    confirmedBookingID INT NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    paymentDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    notes TEXT DEFAULT NULL,
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (confirmedBookingID) REFERENCES confirmedbooking(confirmedBookingID)
);

ALTER TABLE `payment` CHANGE `paymentStatus` `paymentStatus` INT(11) NOT NULL DEFAULT '1';

CREATE TABLE walkin_sales_summary (
    salesID INT PRIMARY KEY AUTO_INCREMENT,
    salesDate DATE NOT NULL,
    bookingType ENUM('Resort', 'Hotel', 'Event') NOT NULL,
    salesAmount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE additionalcharges (
    additionalChargeID INT PRIMARY KEY AUTO_INCREMENT,
    bookingID INT NOT NULL,
    chargeDescription VARCHAR(255) NOT NULL,  -- What the charge is for
    amount DECIMAL(10,2) NOT NULL,             -- Charge amount
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (bookingID) REFERENCES booking(bookingID)
);


CREATE TABLE reasons (
    reasonID INT PRIMARY KEY AUTO_INCREMENT,
    category ENUM('Cancellation', 'Rejection') NOT NULL,
    reasonDescription VARCHAR(255) NOT NULL
);

INSERT INTO reason (category, reasonDescription) VALUES
('Cancellation', 'Change of plans'),
('Cancellation', 'Found a better place or event'),
('Cancellation', 'Price is too expensive'),
('Cancellation', 'Family or personal emergency'),
('Cancellation', 'Health or medical issue'),
('Cancellation', 'Unable to travel'),
('Cancellation', 'Incorrect booking details'),
('Cancellation', 'Trip or event was cancelled'),
('Cancellation', 'Other'),
('BookingRejection', 'No rooms, seats, or spaces available'),
('BookingRejection', 'Missing or incorrect information'),
('BookingRejection', 'Booking appears unsafe or suspicious'),
('BookingRejection', 'Does not meet booking rules or requirements'),
('BookingRejection', 'Duplicate booking detected'),
('BookingRejection', 'Breaks property or event policy'),
('BookingRejection', 'Invalid booking date selected'),
('Rejection', 'Other'),
('PaymentRejection', 'Payment was not completed or declined'),
('PaymentRejection', 'Payment method is invalid or expired'),
('PaymentRejection', 'Insufficient payment'),
('PaymentRejection', 'Payment could not be verified'),
('PaymentRejection', 'Duplicate payment detected'),
('PaymentRejection', 'Other'),
('PartnerRejection', 'Incomplete or missing documents'),
('PartnerRejection', 'Invalid or unverifiable business information'),
('PartnerRejection', 'Duplicate partnership request'),
('PartnerRejection', 'Existing active partnership for same partner type and service'),
('PartnerRejection', 'Partner type not eligible for requested service'),
('PartnerRejection', 'Service not aligned with partnership criteria'),
('PartnerRejection', 'Failed validation or background check'),
('PartnerRejection', 'Non-compliance with policy requirements'),
('PartnerRejection', 'Other'),
('PartnerServiceRejection', 'Schedule conflict / fully booked'),
('PartnerServiceRejection', 'Event type not supported'),
('PartnerServiceRejection', 'Insufficient notice for preparation'),
('PartnerServiceRejection', 'Unable to meet specific client customizations'),
('PartnerServiceRejection', 'Required resources or equipment unavailable'),
('PartnerServiceRejection', 'Other');


-- INSERT INTO reason (category, reasonDescription) VALUES
-- ('PartnerRejection', 'Incomplete or missing documents'),
-- ('PartnerRejection', 'Invalid or unverifiable business information'),
-- ('PartnerRejection', 'Duplicate partnership request'),
-- ('PartnerRejection', 'Existing active partnership for same partner type and service'),
-- ('PartnerRejection', 'Partner type already linked to a similar service'),
-- ('PartnerRejection', 'Partner type not eligible for requested service'),
-- ('PartnerRejection', 'Service not aligned with partnership criteria'),
-- ('PartnerRejection', 'Failed validation or background check'),
-- ('PartnerRejection', 'Non-compliance with policy requirements'),
-- ('PartnerRejection', 'Other');




CREATE TABLE booking_cancellations (
    cancellationID INT PRIMARY KEY AUTO_INCREMENT,
    bookingID INT NOT NULL,
    userID INT NOT NULL,
    reasonID INT NOT NULL,
    otherReason TEXT NULL,
    cancelledAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (bookingID) REFERENCES booking(bookingID),
    FOREIGN KEY (userID) REFERENCES user(userID),
    FOREIGN KEY (reasonID) REFERENCES reason(reasonID)
);

-- ======================
-- BOOKING REJECTIONS
-- ======================
CREATE TABLE booking_rejections (
    rejectionID INT PRIMARY KEY AUTO_INCREMENT,
    bookingID INT NOT NULL,
    adminID INT NOT NULL,
    reasonID INT NOT NULL,
    otherReason TEXT NULL,
    rejectedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (bookingID) REFERENCES booking(bookingID),
    FOREIGN KEY (adminID) REFERENCES admin(adminID),
    FOREIGN KEY (reasonID) REFERENCES reason(reasonID)
);


CREATE TABLE partner_rejection (
    rejectionID INT PRIMARY KEY AUTO_INCREMENT,
    partnershipID INT NOT NULL,
    adminID INT NOT NULL,
    reasonID INT NOT NULL,
    otherReason TEXT NULL,
    rejectedOn TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (partnershipID) REFERENCES partnership(partnershipID),
    FOREIGN KEY (adminID) REFERENCES admin(adminID),
    FOREIGN KEY (reasonID) REFERENCES reason(reasonID)
);


RENAME TABLE booking_rejections TO booking_rejection
RENAME TABLE booking_cancellations TO booking_cancellation
RENAME TABLE additionalcharges TO additionalcharge

ALTER TABLE `reason` CHANGE `category` `category` VARCHAR(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL;
ALTER TABLE confirmedbooking ADD approvedBy INT(11) NULL AFTER paymentApprovalStatus, ADD approvedDate DATETIME NULL AFTER approvedBy;
ALTER TABLE confirmedbooking ADD CONSTRAINT confirmedbooking_ibfk_4 FOREIGN KEY (approvedBy) REFERENCES admin`(adminID`) ON DELETE RESTRICT ON UPDATE RESTRICT;
ALTER TABLE `payment` ADD `downpaymentImage` VARCHAR(255) NOT NULL DEFAULT 'defaultDownpayment.png' AFTER `amount`;
ALTER TABLE `serviceunavailabledate` ADD `expiresAt` DATETIME NULL AFTER `unavailableEndDate`;
ALTER TABLE `serviceunavailabledate` ADD `status` ENUM('hold', 'confirmed', 'cancelled') NOT NULL DEFAULT 'hold' AFTER `unavailableEndDate`;


ALTER TABLE `serviceunavailabledate` ADD `bookingID` INT NOT NULL AFTER `serviceUnavailableID`;
ALTER TABLE walkin_sales_summary ADD bookingCount INT(50) NOT NULL DEFAULT 0 AFTER bookingType;
ALTER TABLE walkin_sales_summary CHANGE salesDate startDate DATE NOT NULL;
ALTER TABLE walkin_sales_summary ADD endDate DATE NULL AFTER startDate;


ALTER TABLE `booking` ADD `additionalCharge` DECIMAL(10,2) NOT NULL DEFAULT '0.00' AFTER `totalCost`;